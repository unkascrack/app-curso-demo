<!DOCTYPE html>
<html lang="es" ng-app="myApp" ng-controller="RootController">
<head>
	<meta charset="utf-8">
	<title>Demo - Catálogo de Cursos</title>
	<link rel="stylesheet" href="../css/normalize.css">
	<link rel="stylesheet" href="../css/style.css">
	<link rel="stylesheet" href="../css/jquery-ui-1.10.3.custom.min.css">
	<link rel="stylesheet" href="css/ng-grid.css">
</head>
<body>
	<div loading>Loading...</div>

	<ng-include src="'templates/header.html'"></ng-include>
	
	<div ng-view></div>

	<div ng-include="'templates/footer.html'"></div>

	
	<script src="../js/comun.js" type="text/javascript"></script>
	<script src="../js/jquery-1.9.1.min.js" type="text/javascript"></script>
	<script src="../js/jquery-ui-1.10.3.custom.min.js" type="text/javascript"></script>
	
	<script src="js/libs/angular.min.js" type="text/javascript"></script>
	<script src="js/libs/angular-resource.min.js" type="text/javascript"></script>
	<script src="js/libs/ng-grid-2.0.5.debug.js" type="text/javascript"></script>
	
	<script type="text/javascript">
		function empty(data) {
			return data === null || data === '' || typeof data === 'undefined' || (data instanceof Object && Object.keys(data).length == 0);
		}
		
		function strcmp(a, b) {
			if (empty(a) && empty(b)) return 0;
		    if (!empty(a) && empty(b) ||  a.toString() < b.toString()) return -1;
		    if (empty(a) && !empty(b) || a.toString() > b.toString()) return 1;
		    return 0;
		}
	
		function trim(data) {
			var y;
			for ( var x in data) {
				y = data[x];
				if (empty(y)) {
					delete data[x];
				}
				if (y instanceof Object) {
					y = trim(y);
				}
			}
			return data;
		}
	</script>
	
	<script type="text/javascript">
		//TODO: actualizar a la versión ngGrid 2.0.6 (corrige bug totalServerItems)
		var app = angular.module('myApp', ['ngGrid', 'myApp.directives', 'myApp.services']);
		
		// ROUTES 
		app.config(['$routeProvider', function($routeProvider) {
			$routeProvider
				.when('/login', {templateUrl:'templates/login.html'})
				.when('/400', {templateUrl:'templates/error400.html'})
				.when('/500', {templateUrl:'templates/error500.html'})
				.when('/cursos', {templateUrl:'templates/cursos/list.html'})
				.when('/cursos/new', {controller: 'NewCursoController', templateUrl:'templates/cursos/edit.html'})
				.when('/cursos/:id', {templateUrl:'templates/cursos/show.html'})
				.when('/cursos/:id/edit', {controller: 'EditCursoController', templateUrl:'templates/cursos/edit.html'})
				.otherwise({redirectTo: '/cursos'});
		}]);
	</script>
	
	<script type="text/javascript">
		// DIRECTIVAS
		var directives = angular.module('myApp.directives', []);
		
		directives.directive('focus', function() {
			return {
				link: function(scope, element, attrs, controller) {
					element[0].focus();
				}
			};
		});
		
		directives.directive('loading', ['$rootScope', function($rootScope) {
			return {
				link: function(scope, element, attrs) {
					element.addClass('hide');
					$rootScope.$on('$routeChangeStart', function() {
						element.removeClass('hide');
					});
					$rootScope.$on('$routeChangeSuccess', function() {
						element.addClass('hide');
					});
				}
			};
		}]);
		
		directives.directive('datepicker', function() {
			return {
				restrict: 'A',
				require: '?ngModel',
				scope: {select: '&'},
				link: function(scope, element, attrs, ngModel) {
					if (!ngModel) return;
					var optionsObj = {};
					optionsObj.dateFormat = 'dd/mm/yy';
					var updateModel = function(dateTxt) {
						scope.$apply(function () {
							ngModel.$setViewValue(dateTxt);
						});
					};
					optionsObj.onSelect = function(dateTxt, picker) {
					updateModel(dateTxt);
					if (scope.select) {
						scope.$apply(function() {
							scope.select({date: dateTxt});
						});
					}
					};
					ngModel.$render = function() {
						element.datepicker('setDate', ngModel.$viewValue || '');
					};
					element.datepicker(optionsObj);
				}
			};
		});
	</script>
		
	<script type="text/javascript">
		// SERVICES
		var services = angular.module('myApp.services', ['ngResource']);
		
		
		services.config(['$httpProvider', function ($httpProvider) {
			$httpProvider.responseInterceptors.push('errorHttpInterceptor');
		}]);
		
		services.factory('errorHttpInterceptor', ['$q', '$location', '$rootScope', 
			function ($q, $location, $rootScope) {
				return function (promise) {
					return promise.then(function (response) {
						return response;
					}, function (response) {
						if (response.status === 401) {
							$rootScope.$broadcast('event:loginRequired');
						} else if (response.status >= 400 && response.status < 500) {
							$rootScope.$broadcast('event:resourceNotFound');
						} else if (response.status >= 500) {
							$rootScope.$broadcast('event:internalServerError');
						}
						return $q.reject(response);
					});
				};
		}]);
		
		services.factory('CursoResource', ['$resource', function($resource) {
			return $resource(getURLEscaped() + 'rest/jackson/secured/cursos/:id', 
					{id: '@id'},
					{total: {method:'GET', params:{total:true}, isArray:false}});
		}]);
		
		services.factory('TutorResource', ['$resource', function($resource) {
			return $resource(getURLEscaped() + 'rest/jackson/tutores/:id', {id: '@id'});
		}]);
	</script>
		
	<script type="text/javascript">
		// CONTROLLERS
		
		// TODO: lista de cosas faltan por realizar
		//  - revisar las búsquedas de listados el orden podría ser datos de página y si llegamos a datosPagina.length = pageSize entonces buscar el total
		//  - construir una clase javascript comun que gestione todos los controles de los grid
		//  - sistema de autenticación
		
		
		app.controller('RootController', ['$scope', '$location', function($scope, $location) {
			$scope.$on('event:loginRequired', function() {
				console.log('login required');
				$location.path('/login');
			});
			$scope.$on('event:resourceNotFound', function() {
				$location.path('/400');
			});
			$scope.$on('event:internalServerError', function() {
				$location.path('/500');
			});
		}]);
		
 		app.controller('ListCursoController', ['$scope', 'CursoResource', function($scope, CursoResource) {
		    $scope.pagingOptions = {
		        pageSizes: [2, 5, 10],
		        pageSize: 2,
		        currentPage: 1
		    };
 		    $scope.filterOptions = {
		        activo: null,
				titulo: null
			};
 			$scope.sortInfo = {
 				fields: [], 
 				columns: [], 
 				directions: []
 			};
		    $scope.gridOptions = {
		        data: 'myData',
		        columnDefs: [{field:'activo', displayName:'Activo', sortable:false}, {field:'titulo', displayName:'Título'}, {field:'nivel', displayName:'Nivel'}, {field:'horas', displayName:'Horas'}, {field:'temario', displayName:'Temario'}],
		        enablePaging: true,
				showFooter: true,
				totalServerItems: 'totalServerItems',
		        pagingOptions: $scope.pagingOptions,
		        i18n: 'sp',
		        useExternalSorting: true,
		        sortInfo: $scope.sortInfo
		    };
		    
		    search($scope.filterOptions, $scope.pagingOptions.pageSize, $scope.pagingOptions.currentPage);
 			
		    function search(filter, pageSize, page, orderBy, orderSort) {
		    	searchNuDataAsync(filter, function() {
			    	if ($scope.totalServerItems === 0) {
			    		$scope.myData = [];
			    	}
			    	else {
		    			searchDataAsync(filter, pageSize, page, orderBy, orderSort);
			    	}
		    	});
		    }
		    
		    function searchNuDataAsync(filter, callback) {
		        setTimeout(function () {
		        	var params = {};
		        	params.activo = filter.activo;
		        	params.titulo = filter.titulo;
			        CursoResource.total(trim($scope.filterOptions), function success(data) {
			        	var total = parseInt(data[0]);
			        	$scope.totalServerItems = total;
			        	if (callback !== null) {
			        		callback();
			        	}
			        });
		        }, 100);
		    };
		    
		    function searchDataAsync(filter, pageSize, page, orderBy, orderSort) {
		        setTimeout(function () {
		        	var params = {};
		        	params.activo = filter.activo;
		        	params.titulo = filter.titulo;
		        	params.pageSize = pageSize;
		        	params.page = page;
		        	params.orderBy = orderBy;
		        	params.orderSort = !orderSort ? null : orderSort.toLowerCase() === 'asc' ? true : false;
		        	CursoResource.query(trim(params), function success(data) {
		        		$scope.myData = data;
		        		if (!$scope.$$phase) {
				            $scope.$apply();
				        }
		        	});
		        }, 100);
		    }; 

		    var filtering = false;
		    
 			$scope.filtrar = function(activo, titulo) {
 				var oldVal = $scope.filterOptions;
 				if (oldVal.activo !== activo || strcmp(titulo, oldVal.titulo) !== 0) {
 					filtering = true;
 					$scope.filterOptions.activo = activo;
 					$scope.filterOptions.titulo = titulo;
 					$scope.pagingOptions.currentPage = 1;
 					search($scope.filterOptions, $scope.pagingOptions.pageSize, $scope.pagingOptions.currentPage, $scope.sortInfo.fields[0], $scope.sortInfo.directions[0]);
 				}
 			}
		    
		    $scope.$watch('pagingOptions', function (newVal, oldVal) {
		        if (!filtering && newVal !== oldVal && (newVal.currentPage !== oldVal.currentPage || newVal.pageSize !== oldVal.pageSize)) {
		        	if (newVal.pageSize !== oldVal.pageSize) {
		        		$scope.pagingOptions.currentPage = 1;
		        	}
		        	searchDataAsync($scope.filterOptions, $scope.pagingOptions.pageSize, $scope.pagingOptions.currentPage, $scope.sortInfo.fields[0], $scope.sortInfo.directions[0]);
		        }
		        if (filtering) {
		        	filtering = false;
		        }
		         
		    }, true);
		    
 			$scope.$watch('sortInfo', function (newVal, oldVal) {
		        if (newVal !== oldVal) {
		        	searchDataAsync($scope.filterOptions, $scope.pagingOptions.pageSize, $scope.pagingOptions.currentPage, $scope.sortInfo.fields[0], $scope.sortInfo.directions[0]);
		        }
 		    }, true);
 		}]);
		
		app.controller('NewCursoController', ['$scope', '$location', 'CursoResource', function($scope, $location, CursoResource) {
			$scope.curso = new CursoResource();
			
			$scope.save = function() {
				$scope.curso.$save(function(curso) {
					$location.path('/cursos/'+curso.id);
				});
			};
			$scope.cancel = function() {
				$location.path('/cursos');
			};
		}]);
		
		app.controller('ShowCursoController', ['$scope', '$location', '$routeParams', 'CursoResource', function($scope, $location, $routeParams, CursoResource) {
			$scope.curso = CursoResource.get({id:$routeParams.id});
			
			$scope.edit = function() {
				$location.path('/cursos/'+$routeParams.id+'/edit');
			};
			$scope.remove = function() {
				$scope.curso.$remove(function(curso) {
					$location.path('/cursos');
				});
			};
			$scope.cancel = function() {
				$location.path('/cursos');
			};
		}]);
		
		app.controller('EditCursoController', ['$scope', '$location', '$routeParams', 'CursoResource', function($scope, $location, $routeParams, CursoResource) {
			$scope.curso = CursoResource.get({id:$routeParams.id},
					function success(data) {
						console.log(data);
						if (data.activo == null) {
							alert('no data');
							$location.path('/cursos');
						}
					},
					function error(data) {
						alert('error');
					});
			$scope.save = function() {
				$scope.curso.$update(function(curso) {
					alert(curso.id);
					$location.path('/cursos');
				});
			};
			$scope.cancel = function() {
				console.log($routeParams.id);
				$location.path('/cursos/'+$routeParams.id);
			};
		}]);
		
		app.controller('ListTutorController', ['$scope', 'TutorResource', function($scope, TutorResource) {
			$scope.tutores = TutorResource.query();
		}]);
		
		app.controller('ListNivelController', ['$scope', function($scope) {
			$scope.niveles = ['BASICO', 'INTERMEDIO', 'AVANZADO'];
		}]);
	</script>		
</body>
</html>