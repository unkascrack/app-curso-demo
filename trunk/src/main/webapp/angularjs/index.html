<!DOCTYPE html>
<html lang="es" ng-app='myApp'>
<head>
	<meta charset="utf-8">
	<title>Demo - Catálogo de Cursos</title>
	<link rel="stylesheet" href="../css/normalize.css">
	<link rel="stylesheet" href="../css/style.css">
	<link rel="stylesheet" href="../css/jquery-ui-1.10.3.custom.min.css">
	<link rel="stylesheet" href="css/ng-grid.css">
</head>
<body>
	<div loading>Loading...</div>

	<ng-include src="'templates/header.html'"></ng-include>
	
	<div ng-view></div>

	<div ng-include="'templates/footer.html'"></div>

	
	<script src="../js/comun.js" type="text/javascript"></script>
	<script src="../js/jquery-1.9.1.min.js" type="text/javascript"></script>
	<script src="../js/jquery-ui-1.10.3.custom.min.js" type="text/javascript"></script>
	
	<script src="js/libs/angular.min.js" type="text/javascript"></script>
	<script src="js/libs/angular-resource.min.js" type="text/javascript"></script>
	<script src="js/libs/ng-grid-2.0.5.min.js" type="text/javascript"></script>
	
	<script type="text/javascript">

		function trim_nulls(data) {
			var y;
			for ( var x in data) {
				y = data[x];
				if (y === "null" || y === null || y === "" || typeof y === "undefined" || (y instanceof Object && Object.keys(y).length == 0)) {
					delete data[x];
				}
				if (y instanceof Object) {
					y = trim_nulls(y);
				}
			}
			return data;
		}
	</script>
	
	<script type="text/javascript">
		var app = angular.module('myApp', ['ngGrid', 'myApp.directives', 'myApp.services']);
		
		// ROUTES 
		app.config(['$routeProvider', function($routeProvider) {
			$routeProvider
				.when('/cursos', {templateUrl:'templates/cursos/list.html'})
				.when('/cursos/new', {controller: 'NewCursoController', templateUrl:'templates/cursos/edit.html'})
				.when('/cursos/:id', {templateUrl:'templates/cursos/show.html'})
				.when('/cursos/:id/edit', {controller: 'EditCursoController', templateUrl:'templates/cursos/edit.html'})
				.otherwise({redirectTo: '/cursos'});
		}]);
	</script>
	
	<script type="text/javascript">
		// DIRECTIVAS
		var directives = angular.module('myApp.directives', []);
		
		directives.directive('focus', function() {
			return {
				link: function(scope, element, attrs, controller) {
					element[0].focus();
				}
			};
		});
		
		directives.directive('loading', ['$rootScope', function($rootScope) {
			return {
				link: function(scope, element, attrs) {
					element.addClass('hide');
					$rootScope.$on('$routeChangeStart', function() {
						element.removeClass('hide');
					});
					$rootScope.$on('$routeChangeSuccess', function() {
						element.addClass('hide');
					});
				}
			};
		}]);
		
		directives.directive('datepicker', function() {
			return {
				restrict: 'A',
				require: '?ngModel',
				scope: {select: '&'},
				link: function(scope, element, attrs, ngModel) {
					if (!ngModel) return;
					var optionsObj = {};
					optionsObj.dateFormat = 'dd/mm/yy';
					var updateModel = function(dateTxt) {
						scope.$apply(function () {
							ngModel.$setViewValue(dateTxt);
						});
					};
					optionsObj.onSelect = function(dateTxt, picker) {
					updateModel(dateTxt);
					if (scope.select) {
						scope.$apply(function() {
							scope.select({date: dateTxt});
						});
					}
					};
					ngModel.$render = function() {
						element.datepicker('setDate', ngModel.$viewValue || '');
					};
					element.datepicker(optionsObj);
				}
			};
		});
	</script>
		
	<script type="text/javascript">
		// SERVICES
		var services = angular.module('myApp.services', ['ngResource']);
		
		services.factory('CursoResource', ['$resource', function($resource) {
			return $resource(getURLEscaped() + 'rest/jackson/cursos/:id', 
					{id: '@id'}, 
					{update: {method:'PUT'}});
		}]);
		
		services.factory('TutorResource', ['$resource', function($resource) {
			return $resource(getURLEscaped() + 'rest/jackson/tutores/:id', {id: '@id'});
		}]);
	</script>
		
	<script type="text/javascript">
		// CONTROLLERS
 		app.controller('ListCursoController', ['$scope', 'CursoResource', function($scope, CursoResource) {
 		    $scope.filterOptions = {
	           activo: null,
	           titulo: null
			};
		    $scope.pagingOptions = {
		        pageSizes: [2, 5, 10],
		        pageSize: 2,
		        totalServerItems: 0,
		        currentPage: 1
		    };	
		    $scope.setPagingData = function(data, page, pageSize){	
		        var pagedData = data.slice((page - 1) * pageSize, page * pageSize);
		        $scope.myData = pagedData;
		        $scope.pagingOptions.totalServerItems = data.length;
		        if (!$scope.$$phase) {
		            $scope.$apply();
		        }
		    };
		    $scope.getPagedDataAsync = function (filter, pageSize, page, orderBy, orderSort) {
		        setTimeout(function () {
		        	var params = filter || {};
		        	params.pageSize = pageSize;
		        	params.page = page;
		        	params.orderBy = orderBy != null ? orderBy.field : '';
		        	params.orderSort = orderSort == 'asc' ? true : false;
		        	CursoResource.query(trim_nulls(params), function success(data) {
		        		$scope.setPagingData(data,page,pageSize);
		        	});
		        }, 100);
		    };
			
		    $scope.getPagedDataAsync($scope.filterOptions, $scope.pagingOptions.pageSize, $scope.pagingOptions.currentPage);
			
		    $scope.$watch('pagingOptions', function (newVal, oldVal) {
		        if (newVal !== oldVal && (newVal.currentPage !== oldVal.currentPage || newVal.pageSize !== oldVal.pageSize)) {
		        	if (newVal.pageSize !== oldVal.pageSize) {
		        		$scope.pagingOptions.currentPage = 1;
		        	}
		        	$scope.getPagedDataAsync($scope.filterOptions, $scope.pagingOptions.pageSize, $scope.pagingOptions.currentPage, $scope.sortInfo.columns[0], $scope.sortInfo.directions[0]);
		        }
		    }, true);
		    
 			$scope.filtrar = function() {
 				if ($scope.pagingOptions.currentPage == 1) {
 					$scope.getPagedDataAsync($scope.filterOptions, $scope.pagingOptions.pageSize, $scope.pagingOptions.currentPage, $scope.sortInfo.columns[0], $scope.sortInfo.directions[0]);
 				}
 				else {
 					$scope.pagingOptions.currentPage = 1;
 				}
 			}
 			
 			$scope.sortInfo = {fields: [], columns: [], directions: []};
 			$scope.$watch('sortInfo', function (newVal, oldVal) {
		        if (newVal !== oldVal) {
		        	$scope.getPagedDataAsync($scope.filterOptions, $scope.pagingOptions.pageSize, $scope.pagingOptions.currentPage, $scope.sortInfo.columns[0], $scope.sortInfo.directions[0]);
		        }
 		    }, true);
			
		    $scope.gridOptions = {
		        data: 'myData',
		        columnDefs: [{field:'activo', displayName:'Activo', sortable:false}, {field:'titulo', displayName:'Título'}, {field:'nivel', displayName:'Nivel'}, {field:'horas', displayName:'Horas'}, {field:'temario', displayName:'Temario'}],
		        enablePaging: true,
				showFooter: true,
		        pagingOptions: $scope.pagingOptions,
		        i18n: 'sp',
		        useExternalSorting: true,
		        sortInfo: $scope.sortInfo
		    };
 		}]);
		
		app.controller('NewCursoController', ['$scope', '$location', 'CursoResource', function($scope, $location, CursoResource) {
			$scope.curso = new CursoResource();
			
			$scope.save = function() {
				$scope.curso.$save(function(curso) {
					$location.path('/cursos/'+curso.id);
				});
			};
			$scope.cancel = function() {
				$location.path('/cursos');
			};
		}]);
		
		app.controller('ShowCursoController', ['$scope', '$location', '$routeParams', 'CursoResource', function($scope, $location, $routeParams, CursoResource) {
			$scope.curso = CursoResource.get({id:$routeParams.id});
			
			$scope.edit = function() {
				$location.path('/cursos/'+$routeParams.id+'/edit');
			};
			$scope.remove = function() {
				$scope.curso.$remove(function(curso) {
					$location.path('/cursos');
				});
			};
			$scope.cancel = function() {
				$location.path('/cursos');
			};
		}]);
		
		app.controller('EditCursoController', ['$scope', '$location', '$routeParams', 'CursoResource', function($scope, $location, $routeParams, CursoResource) {
			$scope.curso = CursoResource.get({id:$routeParams.id},
					function success(data) {
						console.log(data);
						if (data.activo == null) {
							alert('no data');
							$location.path('/cursos');
						}
					},
					function error(data) {
						alert('error');
					});
			$scope.save = function() {
				$scope.curso.$update(function(curso) {
					alert(curso.id);
					$location.path('/cursos');
				});
			};
			$scope.cancel = function() {
				console.log($routeParams.id);
				$location.path('/cursos/'+$routeParams.id);
			};
		}]);
		
		app.controller('ListTutorController', ['$scope', 'TutorResource', function($scope, TutorResource) {
			$scope.tutores = TutorResource.query();
		}]);
		
		app.controller('ListNivelController', ['$scope', function($scope) {
			$scope.niveles = ['BASICO', 'INTERMEDIO', 'AVANZADO'];
		}]);
	</script>		

	<script type="text/javascript">
		//MOCKS
		var mockCursos =  
			[
				{
					"id":1,
					"activo":true,
					"tutor":1,
					"titulo":"Curso 1",
					"nivel":"BASICO",
					"horas":20,
					"temario":"temario1.txt"
				},
				{
					"id":2,
					"activo":true,
					"tutor":1,
					"titulo":"Curso 2",
					"nivel":"INTERMEDIO",
					"horas":40,
					"temario":"temario2.txt"
				},
				{
					"id":3,
					"activo":true,
					"tutor":2,
					"titulo":"Curso 3",
					"nivel":"AVANZADO",
					"horas":120,
					"temario":null
				}
			];

		var mockTutores =  
			[
				{
					"id":1,
					"nombre":"Carlos",
					"apellidos":"Alonso González"
				},
				{
					"id":2,
					"nombre":"Perico",
					"apellidos":"Palotes"
				}
			];		
	</script>
</body>
</html>