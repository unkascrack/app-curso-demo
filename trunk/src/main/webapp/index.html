<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="utf-8">
	<title>Ember Starter Kit</title>
	<link rel="stylesheet" href="resources/css/normalize.css">
	<link rel="stylesheet" href="resources/css/style.css">
</head>
<body>
	<script type="text/x-handlebars" data-template-name="application">
    	{{partial 'header'}}
    	{{outlet}}   
    	{{partial 'footer'}}
	</script>
	

	<script type="text/x-handlebars" data-template-name="_header">
		<header>
			<h1>{{#linkTo index}}Catálogo de Cursos{{/linkTo}}</h1>
		</header>
		<hr/>
	</script>

	<script type="text/x-handlebars" data-template-name="_footer">
		<br/>
		<hr/>
		<footer align="right">
			&copy;2013 Carlos Alonso González
		</footer>
	</script>
	
	<script type="text/x-handlebars" data-template-name="cursos">
		<h2>LISTADO DE CURSOS</h2>
		{{#linkTo cursos.new}}Nuevo{{/linkTo}}

		<center>
		<table border="1" cellspacing="0" cellpadding="0" width="80%">
			<thead>
				<tr>
					<th width="20"></th>
					<th>Titulo</th>
					<th width="100">Nivel</th>
					<th width="50">Horas</th>
					<th width="50"></th>
					<th width="50"></th>
				</tr>
			</thead>
			<tbody>
				{{#unless model}}
					<tr>
						<td colspan="5" align="center">No hay ningún curso activo</td>
					</tr>
				{{else}}
					{{#each model}}
						<tr>
							<td>{{id}}</td>
							<td>{{titulo}}</td>
							<td>{{nivel}}</td>
							<td>{{horas}}</td>
							<td align="center">
								{{temario}}
							</td>
							<td align="center">
								{{#linkTo cursos.edit this}}Editar{{/linkTo}}
							</td>
						</tr>
					{{/each}}
				{{/unless}}				
			</tbody>
			<tfoot>
				<tr>
					<td colspan="6">footer</td>
				</tr>
			</tfoot>
		</table>
		<br/>
		<p>
		ListView: http://emberjs.com/list-view/
  		{{#collection Ember.ListView contentBinding="controller" height=200 rowHeight=20 width=500}}
    		{{id}} {{titulo}} {{nivel}} {{horas}}
  		{{/collection}}
		</p>
		</center>
	</script>
	
	<script type="text/x-handlebars" data-template-name="cursos/new">
		{{partial 'cursos/form'}}
	</script>
	
	<script type="text/x-handlebars" data-template-name="cursos/edit">
		{{partial 'cursos/form'}}
	</script>
	
	<script type="text/x-handlebars" data-template-name="cursos/_form">
		<h2>EDICIÓN CURSO</h2>
		<p>
			<label>Activo</label>
			{{view Ember.Checkbox checkedBinding='activo'}}
		</p>

		<p>
			<label>Profesor</label>
			{{view Ember.Select
                    contentBinding='controller.tutores'
					optionValuePath='content.id'
  					optionLabelPath='content.nombreCompleto'
					selectionBinding='tutor'
                    prompt='Seleccione un tutor'
			}}
		</p>

		<p>
			<label>Titulo</label>
			{{view Ember.TextField 
				valueBinding='titulo'}}
		</p>

		<p>
			<label>Nivel</label>
			{{view Ember.Select 
					contentBinding='App.niveles'
					valueBinding='nivel'
                    prompt='Seleccione el nivel'}}

			
		</p>

		<p>
			<label>Horas</label>
			{{view Ember.TextField
					min='0'
					max='500'
					class='numeric'
					type='number' 
					valueBinding='horas'}}
		</p>

		<p>
			<label>Temario</label>
			{{view Ember.TextField
					type='upload' 
					valueBinding='temario'}}
		</p>

		<p>
			<button {{action save}}>Guardar</button>
			<button {{action cancel}}>Cancelar</button>
		</p>
	</script>
	
	<script src="resources/js/libs/jquery-1.9.1.js"></script>
	<script src="resources/js/libs/handlebars-1.0.0-rc.3.js"></script>
	<script src="resources/js/libs/ember-1.0.0-rc.3.js"></script>
	<script src="resources/js/libs/ember-data-1.0.0-rc.3.js"></script>
	<script src="resources/js/libs/list-view.js"></script>
	<script src="resources/js/libs/jquery.numeric.js"></script>
	
	<!-- <script src="resources/js/app.js"></script> -->
	<script type="text/javascript">
	
/* CONFIGURATION ***************************************************************/
App = Ember.Application.create({
	LOG_TRANSITIONS: true
});

//Ember.LOG_BINDINGS = true;

Ember.onerror = function(error) {
	console.log(error.stack);
	alert(error);
}

/*
Ember.onerror = function(error) {
    Em.$.ajax('/error-notification', 'POST', {
      stack: error.stack,
      otherInformation: 'exception message'
    });
}
*/

Ember.TextField.reopen({
	attributeBindings: ['required','min','max']
});

Ember.Select.reopen({
	attributeBindings: ['required']
});

/* ROUTE ***************************************************************/
App.Router.map(function() {
	this.resource('cursos', { path: '/cursos' }, function() {
		this.route('new', { path: 'new' }),
	    this.route('edit', { path: ':curso_id/edit' })
	})
});

App.IndexRoute = Ember.Route.extend({
	redirect: function() {
		this.transitionTo('cursos');
	}
});

App.CursosRoute = Ember.Route.extend({
	model: function(params) {
		//this.get('store.defaultTransaction').rollback();
        return App.Curso.find();
    }
});

App.CursosIndexRoute = Ember.Route.extend({
	model: function(params) {
		//this.get('store.defaultTransaction').rollback();
        return App.Curso.find();
    },
	renderTemplate: function(){
		this.render('cursos', {into:'application'});
	}
});

App.CursosNewRoute = Ember.Route.extend({
	renderTemplate: function(){
		this.render('cursos/new', {into:'application'});
	},
	setupController: function(controller, model) {
		controller.set('content', App.Curso.createRecord());
		controller.set('tutores', App.Tutor.find());
	}
});

App.CursosEditRoute = Ember.Route.extend({
	renderTemplate: function(){
		this.render('cursos/edit', {into:'application'});
	},
	setupController: function(controller, model) {
		controller.set('content', App.Curso.find(model.id));
		controller.set('tutores', App.Tutor.find());
	}
});


/* CONTROLLER ***************************************************************/
App.IndexController = Ember.ArrayController.extend();

App.CursosController = Ember.ArrayController.extend();

App.CursosIndexController = Ember.ArrayController.extend();

App.CursosNewController = Ember.ObjectController.extend({
	tutores: [],
	save: function() {
		this.get('store.defaultTransaction').commit();
		this.transitionToRoute('cursos');
	},
	cancel: function() {
		this.content.deleteRecord();
		this.get('store.defaultTransaction').commit();
		this.transitionToRoute('cursos');
	}
});

App.CursosEditController = Ember.ObjectController.extend({
	tutores: [],
	save: function() {
		this.get('store.defaultTransaction').commit();
		this.transitionToRoute('cursos');
	},
	cancel: function() {
		this.get('store.defaultTransaction').rollback();
		this.transitionToRoute('cursos');
	}
});


/* DATA ***************************************************************/
App.Store = DS.Store.extend({
	revision: 12,
	/*adapter: 'DS.FixtureAdapter'*/
	adapter: DS.RESTAdapter.extend({
		url: 'http://localhost:8080/',
		namespace: 'curso-demo/rest',
		bulkCommit: false,
		serializer: DS.RESTSerializer.extend({
			init: function() {
				this._super();
		        this.map("App.Curso", {tutor: { embedded: "load" }});
			}
		})
	})
});

DS.RESTAdapter.configure('plurals', {
	tutor: 'tutores',
	curso: 'cursos'
});


/* MODEL ***************************************************************/
App.niveles = ['BASICO', 'INTERMEDIO', 'AVANZADO'];

App.Tutor = DS.Model.extend({
	nombre: DS.attr('string'),
	apellidos: DS.attr('string'),
	nombreCompleto: function() {
		return this.get('nombre') + ' ' + this.get('apellidos');
	}.property('nombre', 'apellidos')
});

App.Curso = DS.Model.extend({
	activo: DS.attr('boolean'),
	tutor: DS.belongsTo('App.Tutor'),
	titulo: DS.attr('string'),
	nivel: DS.attr('string'),
	horas: DS.attr('number'),
	temario: DS.attr('string')
});

/* DATA TESTING ***************************************************************/
App.Curso.FIXTURES = 
[
	{
		"id":1,
		"activo":true,
		"tutor":1,
		"titulo":"Curso 1",
		"nivel":"BASICO",
		"horas":20,
		"temario":"ember.js_application_development_how-to.pdf"
	},
	{
		"id":2,
		"activo":true,
		"tutor":1,
		"titulo":"Curso 2",
		"nivel":"INTERMEDIO",
		"horas":40,
		"temario":"ember.js_application_development_how-to.pdf"
	},
	{
		"id":3,
		"activo":true,
		"tutor":1,
		"titulo":"Curso 3",
		"nivel":"INTERMEDIO",
		"horas":60,
		"temario":"ember.js_in_action_ch1.pdf"
	},
	{
		"id":4,
		"activo":true,
		"tutor":[2],
		"titulo":"Curso 3",
		"nivel":"AVANZADO",
		"horas":120,
		"temario":null
	}
];

App.Tutor.FIXTURES = 
[
	{
		"id":1,
		"nombre":"Carlos",
		"apellidos":"Alonso González"
	},
	{
		"id":2,
		"nombre":"Perico",
		"apellidos":"Palotes"
	}
];



$(document).ready(function(){
	$(".numeric").numeric({ negative: false, decimal: false });
});

	</script>
</body>
</html>