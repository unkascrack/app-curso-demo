<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="utf-8">
	<title>Demo - Catalogo de Cursos</title>
	<link rel="stylesheet" href="resources/css/normalize.css">
	<link rel="stylesheet" href="resources/css/style.css">
</head>
<body>
	<script type="text/x-handlebars" data-template-name="application">
    	{{partial 'header'}}
    	{{outlet}}   
    	{{partial 'footer'}}
	</script>

	<script type="text/x-handlebars" data-template-name="_header">
		<header>
			<h1>{{#linkTo index}}Catálogo de Cursos{{/linkTo}}</h1>
		</header>
		<hr/>
	</script>

	<script type="text/x-handlebars" data-template-name="_footer">
		<br/>
		<hr/>
		<footer align="right">
			&copy;2013 Carlos Alonso González
		</footer>
	</script>
	
	<script type="text/x-handlebars" data-template-name="cursos">
		<h2>LISTADO DE CURSOS</h2>
		{{#linkTo cursos.new}}Nuevo{{/linkTo}}

		<center>
		<table border="1" cellspacing="0" cellpadding="0" width="80%">
			<thead>
				<tr>
					<th>Titulo</th>
					<th width="100">Nivel</th>
					<th width="50">Horas</th>
					<th width="50">Temario</th>
					<th width="50"></th>
				</tr>
			</thead>
			<tbody>
				{{#unless model}}
					<tr>
						<td colspan="5" align="center">No hay ningún curso activo</td>
					</tr>
				{{else}}
					{{#each model}}
						<tr>
							<td>{{titulo}}</td>
							<td>{{nivel}}</td>
							<td>{{horas}}</td>
							<td align="center">
								{{#if temario}}
									{{#view App.ClickableView contentBinding='this'}}
										<a href="#">Descargar</a>
									{{/view}}
								{{/if}}
							</td>
							<td align="center">
								{{#linkTo cursos.edit this}}Editar{{/linkTo}}
							</td>
						</tr>
					{{/each}}
				{{/unless}}				
			</tbody>
			<tfoot>
				<tr>
					<td colspan="5">footer</td>
				</tr>
			</tfoot>
		</table>
		</center>
	</script>
	
	<script type="text/x-handlebars" data-template-name="cursos/new">
		{{partial 'cursos/form'}}
	</script>
	
	<script type="text/x-handlebars" data-template-name="cursos/edit">
		{{partial 'cursos/form'}}
	</script>
	
	<script type="text/x-handlebars" data-template-name="cursos/_form">
		<h2>EDICIÓN CURSO</h2>

		<table cellspacing="3">
		<tr>
			<td>Activo</td>
			<td>{{view Ember.Checkbox checkedBinding='activo'}}</td>
		</tr>	
		<tr>
			<td>Profesor</td>
			<td>
				{{view Ember.Select
                    contentBinding='controller.tutores'
					optionValuePath='content.id'
  					optionLabelPath='content.nombreCompleto'
					selectionBinding='tutor'
                    prompt='Seleccione un tutor'
				}}
			</td>
		</tr>
		<tr>
			<td>Título</td>
			<td>{{view Ember.TextField valueBinding='titulo'}}</td>
		</tr>
		<tr>
			<td>Nivel</td>
			<td>
				{{view Ember.Select 
					contentBinding='App.niveles'
					valueBinding='nivel'
                    prompt='Seleccione el nivel'}}
			</td>
		</tr>
		<tr>
			<td>Horas</td>
			<td>{{view Ember.TextField min='0' max='500' class='numeric' type='number' valueBinding='horas'}}</td>
		</tr>
		<tr>
			<td>Temario</td>
			<td>{{view App.UploadFileView name='temario' contentBinding='content'}}</td>
		</tr>
		<tr>
			<td colspan="2" align="center">
				<button {{action save}}>Guardar</button>
				<button {{action cancel}}>Cancelar</button>
			</td>
		</tr>
		</table>
	</script>
	
	<script src="resources/js/libs/jquery-1.9.1.js"></script>
	<script src="resources/js/libs/handlebars-1.0.0-rc.3.js"></script>
	<script src="resources/js/libs/ember-1.0.0-rc.3.js"></script>
	<script src="resources/js/libs/ember-data-1.0.0-rc.3.js"></script>
	<script src="resources/js/libs/jquery.numeric.js"></script>
	
	<!-- <script src="resources/js/app.js"></script> -->
	<script type="text/javascript">
	

	
	
/* CONFIGURATION ***************************************************************/
App = Ember.Application.create({
	LOG_TRANSITIONS: true
});

//Ember.LOG_BINDINGS = true;

Ember.onerror = function(error) {
	console.log(error.stack);
	alert(error);
}

Ember.TextField.reopen({
	attributeBindings: ['required','min','max']
});

$(document).ready(function(){
	$(".numeric").numeric({ negative: false, decimal: false });
});

Ember.Select.reopen({
	attributeBindings: ['required']
});

/* VIEW ***************************************************************/
App.ClickableView = Ember.View.extend({
	content: null,
	click: function(event) {
		var url = 'docs/'+this.content.get('id')+'/'+this.content.get('temario');
		window.open(url, '_blank');
	}
});

App.UploadFileView = Ember.TextField.extend({
	type: 'file',
    attributeBindings: ['name'],
    change: function(evt) {
		var self = this;
		var input = evt.target;
		if (input.files && input.files[0]) {
        	var reader = new FileReader();
        	var that = this;
        	reader.onload = function(e) {
				var fileToUpload = e.srcElement.result;
				var name = self.get('name');
				self.get('controller').set(name, fileToUpload);
				self.get('controller').get('content').set(name, input.files[0].name);
        	}
        	reader.readAsDataURL(input.files[0]);
      	}
	}
});

/* ROUTE ***************************************************************/
App.Router.map(function() {
	this.resource('cursos', { path: '/cursos' }, function() {
		this.route('new', { path: 'new' }),
	    this.route('edit', { path: ':curso_id/edit' })
	})
});

App.IndexRoute = Ember.Route.extend({
	redirect: function() {
		this.transitionTo('cursos');
	}
});

App.CursosRoute = Ember.Route.extend({
	model: function(params) {
		this.get('store.defaultTransaction').rollback();
        return App.Curso.find({ activo: true });
    }
});

App.CursosIndexRoute = Ember.Route.extend({
	model: function(params) {
		this.get('store.defaultTransaction').rollback();
		return App.Curso.find({ activo: true });
    },
	renderTemplate: function(){
		this.render('cursos', {into:'application'});
	}
});

App.CursosNewRoute = Ember.Route.extend({
	content: null,
	temario: null,
	renderTemplate: function(){
		this.render('cursos/new', {into:'application'});
	},
	setupController: function(controller, model) {
		controller.set('content', App.Curso.createRecord());
		controller.set('tutores', App.Tutor.find());
	}
});

App.CursosEditRoute = Ember.Route.extend({
	content: null,
	temario: null,
	renderTemplate: function(){
		this.render('cursos/edit', {into:'application'});
	},
	setupController: function(controller, model) {
		controller.set('content', App.Curso.find(model.id));
		controller.set('tutores', App.Tutor.find());
	}
});


/* CONTROLLER ***************************************************************/
App.IndexController = Ember.ArrayController.extend();

App.CursosController = Ember.ArrayController.extend();

App.CursosIndexController = Ember.ArrayController.extend();

App.CursosNewController = Ember.ObjectController.extend({
	content: null,
	temario: null,
	tutores: [],
	save: function() {
	    this.content.set('attachment', this.temario);
		this.get('store.defaultTransaction').commit();
	    this.transitionToRoute('cursos');
	},
	cancel: function() {
		this.content.deleteRecord();
		this.get('store.defaultTransaction').commit();
		this.transitionToRoute('cursos');
	}
});

App.CursosEditController = Ember.ObjectController.extend({
	content: null,
	temario: null,
	tutores: [],
	save: function() {
		if (this.temario != null) {
			this.content.set('attachment', this.temario);
		}
		this.get('store.defaultTransaction').commit();
		this.transitionToRoute('cursos');
	},
	cancel: function() {
		this.get('store.defaultTransaction').rollback();
		this.transitionToRoute('cursos');
	}
});


/* DATA ***************************************************************/
App.Store = DS.Store.extend({
	revision: 12,
	/*adapter: 'DS.FixtureAdapter'*/
	adapter: DS.RESTAdapter.extend({
		url: 'http://localhost:8080/',
		namespace: 'curso-demo/rest',
		bulkCommit: false,
		serializer: DS.RESTSerializer.extend({
			init: function() {
				this._super();
		        this.map("App.Curso", {tutor: { embedded: "load" }});
			}
		})
	})
});

DS.RESTAdapter.configure('plurals', {
	tutor: 'tutores',
	curso: 'cursos'
});


/* MODEL ***************************************************************/
App.niveles = ['BASICO', 'INTERMEDIO', 'AVANZADO'];

App.Tutor = DS.Model.extend({
	nombre: DS.attr('string'),
	apellidos: DS.attr('string'),
	nombreCompleto: function() {
		return this.get('nombre') + ' ' + this.get('apellidos');
	}.property('nombre', 'apellidos')
});

App.Curso = DS.Model.extend({
	activo: DS.attr('boolean'),
	tutor: DS.belongsTo('App.Tutor'),
	titulo: DS.attr('string'),
	nivel: DS.attr('string'),
	horas: DS.attr('number'),
	temario: DS.attr('string'),
	attachment: DS.attr('string')
});

/* DATA TESTING ***************************************************************/
App.Curso.FIXTURES = 
[
	{
		"id":1,
		"activo":true,
		"tutor":1,
		"titulo":"Curso 1",
		"nivel":"BASICO",
		"horas":20,
		"temario":"temario1.txt"
	},
	{
		"id":2,
		"activo":true,
		"tutor":1,
		"titulo":"Curso 2",
		"nivel":"INTERMEDIO",
		"horas":40,
		"temario":"temario2.txt"
	},
	{
		"id":3,
		"activo":true,
		"tutor":1,
		"titulo":"Curso 3",
		"nivel":"INTERMEDIO",
		"horas":60,
		"temario":null
	},
	{
		"id":4,
		"activo":true,
		"tutor":[2],
		"titulo":"Curso 3",
		"nivel":"AVANZADO",
		"horas":120,
		"temario":null
	}
];

App.Tutor.FIXTURES = 
[
	{
		"id":1,
		"nombre":"Carlos",
		"apellidos":"Alonso González"
	},
	{
		"id":2,
		"nombre":"Perico",
		"apellidos":"Palotes"
	}
];
	</script>
</body>
</html>